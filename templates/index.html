<!DOCTYPE html>
<html lang = "it">
    <head>
        <meta charset = "UTF-8">
        <title>TuttoCarte.it</title>
        <meta name = "theme-color" content = "#1f2324">
        <link rel = "manifest" href = "/manifest.json">
        <link rel = "icon" href = "../static/assets/other/favicon.ico">
        <link rel = "stylesheet" href = "../static/css/min/index.min.css">
        <meta name = "viewport" content = "width = device-width, initial-scale = 1">
        <meta name = "description" content = "Gioca con i tuoi amici a qualsiasi gioco di carte senza la necessitÃ  di avere un mazzo a portata di mano!">
        <link rel = "preconnect" href = "https://fonts.googleapis.com">
        <link rel = "preconnect" href = "https://fonts.gstatic.com" crossorigin>
        <link rel = "stylesheet" href = "https://fonts.googleapis.com/css2?family=Outfit&display=swap">
        <script src = "https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/jquery-mobile@1.5.0-alpha.1/js/core.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/jquery-ui-touch-punch@0.2.3/jquery.ui.touch-punch.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>
        <script>
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("/service-worker.js");
            }
        </script>
    </head>
    <body> <!-- oncontextmenu = "return false"> -->
        <section id = "table">
            <img id = "qrcode" class = "zoomable" src = "https://api.qrserver.com/v1/create-qr-code/?data=TuttoCarte.it/{{room}}&amp;size=55x55&amp;color=f5f5f5&amp;bgcolor=007649" alt = "qrcode">
            <div>
                {% for card in ita_deck %}
                    <img id = "{{card}}" class = "ita card zoomable" src = "../static/assets/backs/ita.jpg" alt = "card">
                {% endfor %}
            </div>
            <div>
                {% for card in fr1_deck %}
                    <img id = "{{card}}" class = "fr1 card zoomable" src = "../static/assets/backs/fr1.jpg" alt = "card">
                {% endfor %}
            </div>
            <div>
                {% for card in fr2_deck %}
                    <img id = "{{card}}" class = "fr2 card zoomable" src = "../static/assets/backs/fr2.jpg" alt = "card">
                {% endfor %}
            </div>
            <img id = "fiche1" class = "fiche clonable zoomable" src = "../static/assets/fiches/fiche1.png" alt = "fiche">
            <img id = "fiche2" class = "fiche clonable zoomable" src = "../static/assets/fiches/fiche2.png" alt = "fiche">
            <img id = "fiche3" class = "fiche clonable zoomable" src = "../static/assets/fiches/fiche3.png" alt = "fiche">
            <img id = "fiche4" class = "fiche clonable zoomable" src = "../static/assets/fiches/fiche4.png" alt = "fiche">
            <img id = "dealer" class = "fiche zoomable" src = "../static/assets/fiches/dealer.png" alt = "fiche">
        </section>
        <section id = "hand"><h5>MANO</h5><div></div></section>
        <script type = "text/javascript" charset = "UTF-8">

            $(function () {

                const socketio = io({ transport: ["websocket"] });
                socketio.on("connect", function () {
                    socketio.emit("join");
                });

                var tavolo = $('#table');
                var carte = $('.zoomable');
                var lastDistance = 0;

                tavolo.on('touchmove', function(event) {
                    event.preventDefault();
                    var touch1 = event.originalEvent.touches[0];
                    var touch2 = event.originalEvent.touches[1];

                    if (touch1 && touch2) {
                        var distance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
                        if (lastDistance !== 0) {
                            var scaleFactor = distance / lastDistance;
                            var centerX = (touch1.clientX + touch2.clientX) / 2;
                            var centerY = (touch1.clientY + touch2.clientY) / 2;

                            carte.each(function() {
                                var carta = $(this);
                                var currentWidth = parseFloat(carta.css('width'));
                                var currentHeight = parseFloat(carta.css('height'));
                                var currentLeft = parseFloat(carta.css('left'));
                                var currentTop = parseFloat(carta.css('top'));

                                var deltaX = currentLeft + currentWidth / 2 - centerX;
                                var deltaY = currentTop + currentHeight / 2 - centerY;

                                carta.css({
                                    width: (currentWidth * scaleFactor) + 'px',
                                    height: (currentHeight * scaleFactor) + 'px',
                                    left: (centerX + deltaX * scaleFactor - currentWidth / 2) + 'px',
                                    top: (centerY + deltaY * scaleFactor - currentHeight / 2) + 'px'
                                });
                            });
                        }
                        lastDistance = distance;
                    }
                });

                tavolo.on('touchend', function() {
                    lastDistance = 0;
                });






                socketio.on("play", function (data) {
                    $("#table").html(data.table);
                });

                socketio.on("turn", function (data) {
                    console.log($("#" + data.card));
                    // $("#" + data.card).attr("src", $("#" + data.card).attr("src").startsWith("static/assets/backs/") ? `static/assets/decks/${$("#" + data.card)[0].classList[0]}/${data.value}` : `static/assets/backs/${$("#" + data.card)[0].classList[0]}.jpg`);
                });

                $("#table").on("touchstart mouseenter", ".card, .fiche", function () {
                    $(this).draggable({
                        start: function () {
                            $(this).css("cursor", "move");
                            if ($(this).hasClass("clonable")) {
                                $(this).clone().appendTo("#table");
                                $(this).removeClass("clonable");
                            }
                        },
                        stop: function () {
                            $(this).css("cursor", "pointer");
                            socketio.emit("play", { room, table: $("#table").html() });
                        }
                    });
                });

                $("#table").on({
                    vclick: function () {
                    },
                    taphold: function () {
                    }
                },".card, .fiche");

                $("#table").on("mousedown", ".card, .fiche", function (event) {
                    switch (event.which) {
                        case 1:
                            alert("C");
                        case 3:
                            alert("D");
                    }
                });

            });
        </script>
    </body>
</html>