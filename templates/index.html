<!DOCTYPE html>
<html lang = "it">
    <head>
        <meta charset = "UTF-8">
        <title>SenzaMazzo.it</title>
        <meta name = "theme-color" content = "#1f2324">
        <!-- <link rel = "manifest" href = "../manifest.json"> -->
        <link rel = "icon" href = "../static/assets/icons/favicon.png">
        <link rel = "stylesheet" href = "../static/css/min/index.min.css">
        <meta name = "viewport" content = "width = device-width, initial-scale = 1">
        <meta name = "description" content = "Gioca con i tuo amici a qualsiasi gioco di carte senza la necessitÃ  di avere un mazzo di carte a portata di mano!">

        <link rel = "preconnect" href = "https://fonts.googleapis.com">
        <link rel = "preconnect" href = "https://fonts.gstatic.com" crossorigin>
        <link rel = "stylesheet" href = "https://fonts.googleapis.com/css2?family=Alata&family=Outfit&display=swap">

        <!-- <script type = "text/javascript">navigator.serviceWorker.register("service-worker.js")</script> -->

        <script src = "https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js"></script>
        <script src = "https://cdn.jsdelivr.net/npm/jquery-ui-touch-punch@0.2.3/jquery.ui.touch-punch.min.js"></script>

        <script src = "https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>
    </head>
    <body>
        <section id = "a">
            <div id = "table" class = "droppable">
                {% if start == True %}
                    <div id = "decks">
                        <div id = "it">
                            {% for card in it %}
                                <img src = "static/assets/decks/it/retro.jpg" id = "{{card}}" class = "card clickable draggable" alt = "card">
                            {% endfor %}
                        </div>
                        <div id = "fr">
                            {% for card in fr %}
                                <img src = "static/assets/decks/fr/retro.jpg" id = "{{card}}" class = "card clickable draggable" alt = "card">
                            {% endfor %}
                        </div>
                    </div>
                    <div id = "start">
                        <h5>FAI SCANNERIZZARE IL QR CODE</h5>
                        <img src = "https://api.qrserver.com/v1/create-qr-code/?data=http://127.0.0.1:5000/{{room}}" id = "qrcode" alt = "qrcode">
                        <h5>O CLICCALO PER COPIARE IL LINK</h5>
                        <button>INIZIA</button>
                    </div>
                {% endif %}
            </div>
        </section>
        <section id = "b">
            <h3>MANO</h3>
            <d id = "hand" class = "droppable"></div>
        </section>
        <section id = "c">
            <textarea id = "public_notes" placeholder = "Note condivise"></textarea>
            <textarea id = "private_notes" placeholder = "Note personali"></textarea>
        </section>

        <script type = "text/javascript">

            $(document).ready(function () {

                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                });

                var socket = io();
                console.log(socket.connected);

                socket.on('error', function (error) {
                    console.error('Socket.IO Error:', error);
                });

                const room = "{{room}}";

                socket.on("connect", function () {
                    socket.emit("join", { room: room });
                });

                socket.on("table", function (data) {
                    $("#table").html(data.table);
                });

                $("#qrcode").click(function () {
                    navigator.clipboard.writeText(`${window.location.host}{{room}}`);
                });

                $("#start button").click(function () {
                    $("#start").remove();
                    $("#decks").show();
                    socket.emit("table", { room: room, "table": $("#table").html() });
                });

                $(".draggable").draggable({});
                $(".droppable").droppable({
                    accept: ".draggable",
                    drop: function (event, ui) {
                        socket.emit("table", { room: room, "table": $("#table").html() });
                    }
                });

                $("#table").on("click", ".clickable", function () {
                    var card = $(this);
                    var src = card.attr("src");

                    if (src.endsWith("retro.jpg")) {
                        if (src.startsWith("static/assets/decks/it/")) {
                            card.attr("src", `static/assets/decks/it/${card.attr("id")}.jpg`);
                        } else if (src.startsWith("static/assets/decks/fr/")) {
                            card.attr("src", `static/assets/decks/fr/${card.attr("id")}.jpg`);
                        }
                    } else {
                        if (src.startsWith("static/assets/decks/it/")) {
                            card.attr("src", "static/assets/decks/it/retro.jpg");
                        } else if (src.startsWith("static/assets/decks/fr/")) {
                            card.attr("src", "static/assets/decks/fr/retro.jpg");
                        }
                    }

                    socket.emit("table", { room: room, "table": $("#table").html() });
                });

            });

        </script>

    </body>
</html>